<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - R-TALKS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>Admin Dashboard</h1>
            <button id="logoutBtn" class="btn-logout">Logout</button>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Tickets Sold</h3>
                <p id="totalTickets">0</p>
            </div>
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <p id="totalRevenue">₹0</p>
            </div>
            <div class="stat-card">
                <h3>Today's Sales</h3>
                <p id="todaySales">0</p>
            </div>
        </div>

        <section class="event-details">
            <h2>Event Details</h2>
            <form id="eventForm" class="event-form">
                <div class="form-group">
                    <label for="title">Event Title</label>
                    <input type="text" id="title" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" required></textarea>
                </div>
                <div class="form-group">
                    <label for="date">Date</label>
                    <input type="date" id="date" required min="2024-01-01" max="2030-12-31">
                </div>
                <div class="form-group">
                    <label for="time">Time</label>
                    <input type="time" id="time" required>
                </div>
                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" required>
                </div>
                <div class="form-group">
                    <label for="price">Price (₹)</label>
                    <input type="number" id="price" required>
                </div>
                <button type="submit" class="btn-primary">Update Event</button>
            </form>
        </section>

        <section class="content-management">
            <h2>Homepage Content Management</h2>
            
            <!-- Hero Section -->
            <div class="content-section">
                <h3>Hero Section</h3>
                <form id="heroForm" class="content-form">
                    <div class="form-group">
                        <label for="heroTitle">Main Title</label>
                        <input type="text" id="heroTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="heroSubtitle">Subtitle</label>
                        <input type="text" id="heroSubtitle" required>
                    </div>
                    <div class="form-group">
                        <label for="heroDescription">Description</label>
                        <textarea id="heroDescription" required></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Update Hero Section</button>
                </form>
            </div>

            <!-- Event Packages Section -->
            <div class="content-section">
                <h3>Event Packages Management</h3>
                <form id="packagesForm" class="content-form">
                    <div class="form-group">
                        <label for="packagesTitle">Section Title</label>
                        <input type="text" id="packagesTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="packagesDescription">Description</label>
                        <textarea id="packagesDescription" required></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Update Section Info</button>
                </form>

                <!-- Dynamic Package Management -->
                <div class="packages-management">
                    <div class="packages-header">
                        <h4>Manage Packages</h4>
                        <button type="button" class="btn-primary" onclick="addNewPackage()">+ Add New Package</button>
                    </div>
                    <div id="packagesContainer">
                        <!-- Packages will be loaded dynamically -->
                    </div>
                </div>
            </div>
        </section>

        <section class="speakers-management">
            <h2>Speakers Management</h2>
            
            <div class="content-section">
                <div class="speakers-header">
                    <h3>Manage Speakers</h3>
                    <button type="button" class="btn-primary" onclick="addNewSpeaker()">+ Add New Speaker</button>
                </div>
                <div id="speakersContainer">
                    <!-- Speakers will be loaded dynamically -->
                </div>
            </div>
        </section>

        <section class="contact-info-management">
            <h2>Contact Information Management</h2>
            
            <div class="content-section">
                <h3>Update Contact Information</h3>
                <form id="contactInfoForm" class="content-form">
                    <div class="form-group">
                        <label for="contactPhones">Phone Numbers (one per line)</label>
                        <textarea id="contactPhones" rows="4" placeholder="+91 99406 25080&#10;+91 78100 78717&#10;+91 63699 97015&#10;+91 99522 47355"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="contactEmail">Email Address</label>
                        <input type="email" id="contactEmail" placeholder="manikandan@aicraise.com">
                    </div>
                    <div class="form-group">
                        <label for="contactVenue">Venue Name</label>
                        <input type="text" id="contactVenue" placeholder="Rathinam Grand Hall">
                    </div>
                    <div class="form-group">
                        <label for="contactArea">Area</label>
                        <input type="text" id="contactArea" placeholder="Eachanari - 021">
                    </div>
                    <div class="form-group">
                        <label for="contactBuilding">Building/Tech Park</label>
                        <input type="text" id="contactBuilding" placeholder="Rathinam Tech Park">
                    </div>
                    <div class="form-group">
                        <label for="contactAddress">Address</label>
                        <input type="text" id="contactAddress" placeholder="Pollachi Main Rd, Eachanari">
                    </div>
                    <div class="form-group">
                        <label for="contactCity">City & State</label>
                        <input type="text" id="contactCity" placeholder="Coimbatore, Tamil Nadu 641021">
                    </div>
                    <button type="submit" class="btn-primary">Update Contact Information</button>
                </form>
            </div>
        </section>

        <section class="orders">
            <h2>Recent Orders</h2>
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer Name</th>
                        <th>Email</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody"></tbody>
            </table>
        </section>

        <section class="contact-forms">
            <h2>Contact Forms</h2>
            <div class="contact-forms-header">
                <button type="button" class="btn-primary" onclick="exportContactForms()">📄 Export to Excel</button>
            </div>
            <table class="orders-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Message</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="contactFormsTableBody"></tbody>
            </table>
        </section>
    </div>

    <script src="/js/config.js"></script>
    <script>
        // Always use production API for admin panel
        const API_URL = 'https://rtalks-back.onrender.com/api';
        
        console.log('🔗 Admin Dashboard using API URL:', API_URL);
        
        // Enhanced API call function with CORS and authentication handling
        async function apiCall(endpoint, options = {}) {
            try {
                // Enhanced request configuration for CORS compatibility
                const requestConfig = {
                    method: options.method || 'GET',
                    credentials: 'include',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        // Remove cache-control to avoid CORS preflight issues
                        ...options.headers
                    },
                    ...options
                };
                
                // Remove cache-control for CORS compatibility
                if (requestConfig.headers['Cache-Control']) {
                    delete requestConfig.headers['Cache-Control'];
                }
                
                console.log(`🌐 Making API call to ${endpoint}:`, requestConfig);
                
                const response = await fetch(`${API_URL}/${endpoint}`, requestConfig);
                
                console.log(`📡 Response for ${endpoint}:`, response.status, response.statusText);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Network error' }));
                    
                    if (response.status === 401) {
                        // Check if we're in fallback mode
                        const loginSuccess = localStorage.getItem('adminLoginSuccess');
                        const loginTimestamp = loginSuccess ? parseInt(loginSuccess) : 0;
                        const now = Date.now();
                        const fiveMinutes = 5 * 60 * 1000;
                        
                        if (loginTimestamp && (now - loginTimestamp) < fiveMinutes) {
                            console.log(`⚠️ API call to ${endpoint} failed with 401, using fallback data due to CORS issues`);
                            return getFallbackData(endpoint);
                        } else {
                            console.log('⚠️ Authentication expired, redirecting to login');
                            setTimeout(() => {
                                window.location.href = '/admin/login.html';
                            }, 1000);
                            return getFallbackData(endpoint);
                        }
                    }
                    
                    // Handle CORS errors gracefully
                    if (response.status === 0 || errorData.error?.includes('CORS')) {
                        console.log(`🚫 CORS error for ${endpoint}, using fallback data`);
                        return getFallbackData(endpoint);
                    }
                    
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`❌ API call failed for ${endpoint}:`, error);
                
                // Handle network errors and CORS issues with fallback
                const loginSuccess = localStorage.getItem('adminLoginSuccess');
                const loginTimestamp = loginSuccess ? parseInt(loginSuccess) : 0;
                const now = Date.now();
                const fiveMinutes = 5 * 60 * 1000;
                
                if (loginTimestamp && (now - loginTimestamp) < fiveMinutes) {
                    if (error.name === 'TypeError' || error.message.includes('CORS') || error.message.includes('fetch')) {
                        console.log(`🔄 Network/CORS error for ${endpoint}, using fallback data`);
                        return getFallbackData(endpoint);
                    }
                }
                
                throw error;
            }
        }
        
        // Provide fallback data when API calls fail
        function getFallbackData(endpoint) {
            console.log(`📦 Providing fallback data for ${endpoint}`);
            
            const fallbackData = {
                'admin/stats': {
                    totalTickets: 0,
                    totalRevenue: 0,
                    todaySales: 0
                },
                'admin/orders': [],
                'admin/content': [],
                'admin/packages': [],
                'admin/speakers': [],
                'admin/contact-forms': [],
                'admin/contact-info': {
                    phone_numbers: [],
                    email: '',
                    location: {}
                },
                'event': {
                    title: 'R-TALKS SUMMIT 2025',
                    description: 'TALENT ACQUISITION LEADER\'S KNOWLEDGE SUMMIT',
                    date: '2025-03-15',
                    time: '09:00',
                    location: 'Virtual Event',
                    price: 2999
                }
            };
            
            return fallbackData[endpoint] || {};
        }
        
        // Check authentication on load with fallback support
        async function checkAuth() {
            console.log('🔍 Starting authentication check...');
            
            try {
                // Show loading state
                document.body.style.opacity = '0.5';
                
                // Check for fallback authentication flag
                const forceAuthCheck = localStorage.getItem('forceAuthCheck');
                const loginSuccess = localStorage.getItem('adminLoginSuccess');
                const loginTimestamp = loginSuccess ? parseInt(loginSuccess) : 0;
                const now = Date.now();
                const fiveMinutes = 5 * 60 * 1000; // 5 minutes
                
                console.log('🍪 Current cookies:', document.cookie);
                console.log('💾 Fallback auth check:', forceAuthCheck);
                console.log('💾 Login timestamp:', loginTimestamp, 'Age:', (now - loginTimestamp) / 1000, 'seconds');
                
                // If we have a recent login success and force auth flag, try to proceed
                if (forceAuthCheck === 'true' && loginTimestamp && (now - loginTimestamp) < fiveMinutes) {
                    console.log('🔄 Using fallback authentication method...');
                    localStorage.removeItem('forceAuthCheck'); // Clear the flag
                    
                    // Try auth check once more, but don't fail if it doesn't work
                    try {
                        const fallbackResponse = await fetch(`${API_URL}/admin/check-auth`, {
                            method: 'GET',
                            credentials: 'include',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (fallbackResponse.ok) {
                            console.log('✅ Fallback auth check passed!');
                        } else {
                            console.log('⚠️ Fallback auth failed but proceeding anyway due to recent login');
                        }
                    } catch (fallbackError) {
                        console.log('⚠️ Fallback auth error but proceeding anyway:', fallbackError.message);
                    }
                    
                    // Proceed to load dashboard
                    console.log('✅ Proceeding with dashboard load using fallback method');
                    document.body.style.opacity = '1';
                    await loadDashboardData();
                    return;
                }
                
                // Regular authentication check with CORS handling
                console.log('🔍 Calling:', `${API_URL}/admin/check-auth`);
                
                const response = await fetch(`${API_URL}/admin/check-auth`, {
                    method: 'GET',
                    credentials: 'include',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                        // Removed Cache-Control to avoid CORS preflight issues
                    }
                });
                
                console.log('🔍 Auth check response status:', response.status);
                console.log('🔍 Auth check response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Network error' }));
                    console.log('🔍 Auth check error data:', errorData);
                    
                    if (response.status === 401) {
                        console.log('⚠️ 401 Unauthorized - Token invalid or missing');
                        
                        // Check if we have recent login - if so, show specific error
                        if (loginTimestamp && (now - loginTimestamp) < fiveMinutes) {
                            console.log('⚠️ Recent login detected but auth failed - cookie sharing issue');
                            alert('Authentication issue detected!\n\nThis is likely a cookie sharing problem between domains.\n\nRedirecting to login page...');
                        }
                        
                        setTimeout(() => {
                            console.log('🔄 Redirecting to login due to 401...');
                            window.location.href = '/admin/login.html';
                        }, 2000);
                        return;
                    }
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('✅ Authentication successful:', data);
                
                // Clear any fallback flags on successful auth
                localStorage.removeItem('forceAuthCheck');
                localStorage.removeItem('adminLoginSuccess');
                
                // Show success and restore opacity
                document.body.style.opacity = '1';
                
                await loadDashboardData();
                
            } catch (error) {
                console.error('❌ Auth check failed:', error);
                document.body.style.opacity = '1';
                
                // Check for recent login before redirecting
                const loginSuccess = localStorage.getItem('adminLoginSuccess');
                const loginTimestamp = loginSuccess ? parseInt(loginSuccess) : 0;
                const now = Date.now();
                const fiveMinutes = 5 * 60 * 1000;
                
                if (loginTimestamp && (now - loginTimestamp) < fiveMinutes) {
                    console.log('⚠️ Auth failed but recent login detected - showing specific error');
                    alert(`Authentication failed but you logged in recently.

Error: ${error.message}

This suggests a cookie/CORS issue.

Redirecting to login in 3 seconds...`);
                } else {
                    alert(`Authentication failed: ${error.message}\n\nRedirecting to login in 3 seconds...`);
                }
                
                setTimeout(() => {
                    console.log('🔄 Redirecting to login due to auth failure...');
                    window.location.href = '/admin/login.html';
                }, 3000);
            }
        }
        
        // Load dashboard data with enhanced fallback handling
        async function loadDashboardData() {
            console.log('🔄 Loading dashboard data...');
            
            // Show a notice if we're using fallback authentication
            const loginSuccess = localStorage.getItem('adminLoginSuccess');
            const loginTimestamp = loginSuccess ? parseInt(loginSuccess) : 0;
            const now = Date.now();
            const fiveMinutes = 5 * 60 * 1000;
            
            if (loginTimestamp && (now - loginTimestamp) < fiveMinutes) {
                console.log('📦 Loading with fallback authentication due to cookie sharing issues');
                showFallbackNotice();
            }
            
            // Load data with graceful error handling
            const loadPromises = [
                loadEventDetails().catch(err => console.warn('Event details load failed:', err)),
                loadOrders().catch(err => console.warn('Orders load failed:', err)),
                updateStats().catch(err => console.warn('Stats load failed:', err)),
                loadContentData().catch(err => console.warn('Content load failed:', err)),
                loadPackages().catch(err => console.warn('Packages load failed:', err)),
                loadSpeakers().catch(err => console.warn('Speakers load failed:', err)),
                loadContactForms().catch(err => console.warn('Contact forms load failed:', err)),
                loadContactInfo().catch(err => console.warn('Contact info load failed:', err))
            ];
            
            await Promise.allSettled(loadPromises);
            console.log('✅ Dashboard loading completed (some items may use fallback data)');
        }
        
        // Show enhanced fallback notice with CORS information
        function showFallbackNotice() {
            const notice = document.createElement('div');
            notice.id = 'fallback-notice';
            notice.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                color: #856404;
                padding: 15px 18px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
                max-width: 350px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                line-height: 1.4;
            `;
            notice.innerHTML = `
                <strong>🚫 CORS Issue Detected</strong><br>
                <small>Vercel ↔️ Render cross-origin limitation</small><br><br>
                <strong>Status:</strong> Using fallback data mode<br>
                <strong>Functionality:</strong> Limited but operational<br><br>
                <details style="margin-top: 8px;">
                    <summary style="cursor: pointer; font-weight: bold;">Technical Details ▼</summary>
                    <div style="margin-top: 8px; font-size: 12px; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                        • Frontend: rtalks-frontend.vercel.app<br>
                        • Backend: rtalks-back.onrender.com<br>
                        • Issue: ALLOWED_ORIGINS configuration<br>
                        • Solution: Update backend CORS settings
                    </div>
                </details><br>
                <button onclick="this.parentElement.remove()" style="padding: 6px 12px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer; font-size: 12px;">Dismiss</button>
            `;
            
            // Remove any existing notice
            const existing = document.getElementById('fallback-notice');
            if (existing) existing.remove();
            
            document.body.appendChild(notice);
            
            // Auto-remove after 15 seconds
            setTimeout(() => {
                if (notice.parentElement) notice.remove();
            }, 15000);
        }

        // Load event details
        async function loadEventDetails() {
            try {
                const eventData = await apiCall('event');
                
                if (eventData) {
                    document.getElementById('title').value = eventData.title || '';
                    document.getElementById('description').value = eventData.description || '';
                    
                    // Enhanced date format handling
                    if (eventData.date) {
                        try {
                            const date = new Date(eventData.date);
                            
                            if (!isNaN(date.getTime())) {
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const day = String(date.getDate()).padStart(2, '0');
                                const formattedDate = `${year}-${month}-${day}`;
                                document.getElementById('date').value = formattedDate;
                                console.log('✅ Date loaded successfully:', formattedDate);
                            } else {
                                console.warn('⚠️ Invalid date received from API:', eventData.date);
                                document.getElementById('date').value = '';
                            }
                        } catch (dateError) {
                            console.error('❌ Error parsing date:', dateError, 'Original date:', eventData.date);
                            document.getElementById('date').value = '';
                        }
                    } else {
                        document.getElementById('date').value = '';
                    }
                    
                    document.getElementById('time').value = eventData.time || '';
                    document.getElementById('location').value = eventData.location || '';
                    document.getElementById('price').value = eventData.price || '';
                }
            } catch (error) {
                console.error('❌ Error loading event details:', error);
                // Set default values if API fails
                document.getElementById('title').value = 'R-TALKS SUMMIT 2025';
                document.getElementById('description').value = 'TALENT ACQUISITION LEADER\'S KNOWLEDGE SUMMIT';
                document.getElementById('date').value = '2025-03-15';
                document.getElementById('time').value = '09:00';
                document.getElementById('location').value = 'Virtual Event';
                document.getElementById('price').value = '2999';
            }
        }

        // Update event details
        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get form elements
            const dateInput = document.getElementById('date');
            const dateValue = dateInput.value;
            
            // Validate date input
            if (!dateValue) {
                alert('Please select a date for the event.');
                dateInput.focus();
                return;
            }
            
            // Validate date format and value
            const selectedDate = new Date(dateValue);
            if (isNaN(selectedDate.getTime())) {
                alert('Please enter a valid date.');
                dateInput.focus();
                return;
            }
            
            // Check if date is not in the past (optional validation)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (selectedDate < today) {
                const proceed = confirm('The selected date is in the past. Do you want to continue?');
                if (!proceed) {
                    dateInput.focus();
                    return;
                }
            }
            
            const eventData = {
                title: document.getElementById('title').value.trim(),
                description: document.getElementById('description').value.trim(),
                date: dateValue, // Use the validated date value
                time: document.getElementById('time').value,
                location: document.getElementById('location').value.trim(),
                price: Number(document.getElementById('price').value)
            };
            
            // Validate other required fields
            if (!eventData.title || !eventData.description || !eventData.location) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (isNaN(eventData.price) || eventData.price < 0) {
                alert('Please enter a valid price.');
                document.getElementById('price').focus();
                return;
            }
            
            console.log('Updating event with data:', eventData); // Debug log
            
            try {
                const response = await fetch(`${API_URL}/admin/event`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(eventData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update event');
                }

                alert('Event details updated successfully! The new date will appear on the homepage.');
                
                // Refresh the form to show updated data
                await loadEventDetails();
                
            } catch (error) {
                console.error('Error updating event:', error);
                alert('Error updating event details: ' + error.message);
            }
        });

        // Load orders using apiCall
        async function loadOrders() {
            try {
                const data = await apiCall('admin/orders');
                
                const tableBody = document.getElementById('ordersTableBody');
                if (data && data.length > 0) {
                    tableBody.innerHTML = data.map(order => `
                        <tr>
                            <td>${order.id}</td>
                            <td>${order.customer_name}</td>
                            <td>${order.customer_email}</td>
                            <td>₹${order.amount}</td>
                            <td>${order.status}</td>
                            <td>${new Date(order.created_at).toLocaleDateString()}</td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6">No orders found (using fallback data)</td></tr>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersTableBody').innerHTML = `<tr><td colspan="6" class="error-text">Unable to load orders: ${error.message}</td></tr>`;
            }
        }

        // Update stats using apiCall
        async function updateStats() {
            try {
                const data = await apiCall('admin/stats');
                
                document.getElementById('totalTickets').textContent = data.totalTickets || 0;
                document.getElementById('totalRevenue').textContent = `₹${data.totalRevenue || 0}`;
                document.getElementById('todaySales').textContent = data.todaySales || 0;
            } catch (error) {
                console.error('Error updating stats:', error);
                // Show fallback values instead of "Error"
                document.getElementById('totalTickets').textContent = '0';
                document.getElementById('totalRevenue').textContent = '₹0';
                document.getElementById('todaySales').textContent = '0';
            }
        }

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch(`${API_URL}/admin/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.href = '/admin/login.html';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        });

        // Initialize dashboard
        checkAuth();

        // Content Management Functions
        async function loadContentData() {
            try {
                const contentData = await apiCall('admin/content');
                
                // Populate hero section
                const heroData = contentData.find(c => c.section === 'hero');
                if (heroData) {
                    document.getElementById('heroTitle').value = heroData.title || '';
                    document.getElementById('heroSubtitle').value = heroData.subtitle || '';
                    document.getElementById('heroDescription').value = heroData.description || '';
                }
                
                // Populate packages section info only
                const packagesData = contentData.find(c => c.section === 'event_info');
                if (packagesData) {
                    document.getElementById('packagesTitle').value = packagesData.title || '';
                    document.getElementById('packagesDescription').value = packagesData.description || '';
                }
            } catch (error) {
                console.error('Error loading content data:', error);
                // Set default values as fallback
                document.getElementById('heroTitle').value = 'Buy Event Tickets';
                document.getElementById('heroSubtitle').value = 'RAISE - TALENT ACQUISITION LEADER\'S KNOWLEDGE SUMMIT';
                document.getElementById('heroDescription').value = 'Join us for the biggest R programming conference of the year.';
                document.getElementById('packagesTitle').value = 'Our Event Passes';
                document.getElementById('packagesDescription').value = 'Choose the pass that best suits your professional goals.';
            }
        }

        // Package Management Functions
        let currentPackages = [];

        async function loadPackages() {
            try {
                currentPackages = await apiCall('admin/packages');
                renderPackages();
            } catch (error) {
                console.error('Error loading packages:', error);
                currentPackages = [];
                renderPackages();
            }
        }

        function renderPackages() {
            const container = document.getElementById('packagesContainer');
            if (!currentPackages.length) {
                container.innerHTML = '<p>No packages found. <button type="button" class="btn-primary" onclick="addNewPackage()">Add your first package</button></p>';
                return;
            }

            container.innerHTML = currentPackages.map((pkg, index) => `
                <div class="package-item" data-id="${pkg.id}">
                    <div class="package-header">
                        <h5>Package ${index + 1}: ${pkg.name}</h5>
                        <div class="package-actions">
                            <button type="button" class="btn-small btn-danger" onclick="deletePackage(${pkg.id})">Delete</button>
                            <span class="drag-handle">↕️</span>
                        </div>
                    </div>
                    <div class="package-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Package Name</label>
                                <input type="text" id="pkg${pkg.id}Name" value="${pkg.name}" required>
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <input type="text" id="pkg${pkg.id}Category" value="${pkg.category || ''}" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Price (₹)</label>
                                <input type="number" id="pkg${pkg.id}Price" value="${pkg.price}" required>
                            </div>
                            <div class="form-group">
                                <label>Package Type</label>
                                <select id="pkg${pkg.id}Type" required>
                                    <option value="professional" ${pkg.package_type === 'professional' ? 'selected' : ''}>Professional</option>
                                    <option value="executive" ${pkg.package_type === 'executive' ? 'selected' : ''}>Executive</option>
                                    <option value="leadership" ${pkg.package_type === 'leadership' ? 'selected' : ''}>Leadership</option>
                                    <option value="custom" ${!['professional', 'executive', 'leadership'].includes(pkg.package_type) ? 'selected' : ''}>Custom</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Features (one per line)</label>
                            <textarea id="pkg${pkg.id}Features" rows="3" required>${Array.isArray(pkg.features) ? pkg.features.join('\n') : JSON.parse(pkg.features || '[]').join('\n')}</textarea>
                        </div>
                        <button type="button" class="btn-primary" onclick="updatePackage(${pkg.id})">Update Package</button>
                    </div>
                </div>
            `).join('');
        }

        async function updatePackage(packageId) {
            try {
                const packageData = {
                    name: document.getElementById(`pkg${packageId}Name`).value,
                    category: document.getElementById(`pkg${packageId}Category`).value,
                    price: parseFloat(document.getElementById(`pkg${packageId}Price`).value),
                    features: document.getElementById(`pkg${packageId}Features`).value.split('\n').filter(f => f.trim()),
                    package_type: document.getElementById(`pkg${packageId}Type`).value
                };
                
                const response = await fetch(`${API_URL}/admin/packages/${packageId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(packageData)
                });

                if (!response.ok) {
                    throw new Error('Failed to update package');
                }

                alert('Package updated successfully!');
                await loadPackages(); // Reload to show updated data
            } catch (error) {
                alert('Error updating package: ' + error.message);
            }
        }

        async function deletePackage(packageId) {
            if (!confirm('Are you sure you want to delete this package?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/admin/packages/${packageId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete package');
                }

                alert('Package deleted successfully!');
                await loadPackages(); // Reload to show updated list
            } catch (error) {
                alert('Error deleting package: ' + error.message);
            }
        }

        async function addNewPackage() {
            const packageData = {
                name: 'New Package',
                category: 'New Category',
                price: 999,
                features: ['Feature 1', 'Feature 2', 'Feature 3'],
                package_type: 'custom'
            };
            
            try {
                const response = await fetch(`${API_URL}/admin/packages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(packageData)
                });

                if (!response.ok) {
                    throw new Error('Failed to create package');
                }

                alert('New package created! Please edit the details.');
                await loadPackages(); // Reload to show new package
            } catch (error) {
                alert('Error creating package: ' + error.message);
            }
        }

        // Hero section form handler
        document.getElementById('heroForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const heroData = {
                title: document.getElementById('heroTitle').value,
                subtitle: document.getElementById('heroSubtitle').value,
                description: document.getElementById('heroDescription').value,
                content_data: {
                    buttons: [
                        { text: 'Browse Events', action: 'scrollToTickets' }
                    ]
                }
            };
            
            try {
                const response = await fetch(`${API_URL}/admin/content/hero`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(heroData)
                });

                if (!response.ok) {
                    throw new Error('Failed to update hero section');
                }

                alert('Hero section updated successfully!');
            } catch (error) {
                alert('Error updating hero section: ' + error.message);
            }
        });

        // Packages form handler (for section info only)
        document.getElementById('packagesForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const packagesData = {
                title: document.getElementById('packagesTitle').value,
                subtitle: '',
                description: document.getElementById('packagesDescription').value,
                content_data: {} // Section info only, packages are managed separately
            };
            
            try {
                const response = await fetch(`${API_URL}/admin/content/event_info`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(packagesData)
                });

                if (!response.ok) {
                    throw new Error('Failed to update packages section');
                }

                alert('Packages section info updated successfully!');
            } catch (error) {
                alert('Error updating packages section: ' + error.message);
            }
        });

        // Speakers Management Functions
        
        // Load speakers
        async function loadSpeakers() {
            try {
                const response = await fetch(`${API_URL}/admin/speakers`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const speakers = await response.json();
                displaySpeakers(speakers);
            } catch (error) {
                console.error('Error loading speakers:', error);
                document.getElementById('speakersContainer').innerHTML = `<p class="error-text">Error loading speakers: ${error.message}</p>`;
            }
        }
        
        // Display speakers in admin panel
        function displaySpeakers(speakers) {
            const container = document.getElementById('speakersContainer');
            
            if (!speakers.length) {
                container.innerHTML = '<p>No speakers found. Click "Add New Speaker" to create one.</p>';
                return;
            }
            
            container.innerHTML = speakers.map(speaker => `
                <div class="package-item" data-speaker-id="${speaker.id}">
                    <div class="package-header">
                        <h5>${speaker.name}</h5>
                        <div class="package-actions">
                            <span class="drag-handle">⋮⋮</span>
                            <button type="button" class="btn-small btn-primary" onclick="editSpeaker(${speaker.id})">Edit</button>
                            <button type="button" class="btn-small btn-danger" onclick="deleteSpeaker(${speaker.id})">Delete</button>
                        </div>
                    </div>
                    <div class="speaker-details">
                        <p><strong>Title:</strong> ${speaker.title || 'N/A'}</p>
                        <p><strong>Company:</strong> ${speaker.company || 'N/A'}</p>
                        <p><strong>Bio:</strong> ${speaker.bio ? speaker.bio.substring(0, 100) + '...' : 'N/A'}</p>
                        <p><strong>Image URL:</strong> ${speaker.image_url || 'N/A'}</p>
                    </div>
                    <div id="editSpeaker${speaker.id}" class="package-form" style="display: none;">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="speakerName${speaker.id}" value="${speaker.name}" required>
                        </div>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="speakerTitle${speaker.id}" value="${speaker.title || ''}">
                        </div>
                        <div class="form-group">
                            <label>Company</label>
                            <input type="text" id="speakerCompany${speaker.id}" value="${speaker.company || ''}">
                        </div>
                        <div class="form-group">
                            <label>Bio</label>
                            <textarea id="speakerBio${speaker.id}" rows="3">${speaker.bio || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Profile Image</label>
                            <div class="image-upload-container">
                                <input type="file" id="speakerImageFile${speaker.id}" accept="image/*" onchange="previewImage(${speaker.id}, this)" style="margin-bottom: 10px;">
                                <input type="url" id="speakerImage${speaker.id}" value="${speaker.image_url || ''}" placeholder="Or enter image URL" style="margin-bottom: 10px;" onchange="clearFileInput(${speaker.id})">
                                <div id="imagePreview${speaker.id}" class="image-preview">
                                    ${speaker.image_url ? `<img src="${speaker.image_url}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-primary" onclick="updateSpeaker(${speaker.id})">Update Speaker</button>
                            <button type="button" class="btn-secondary" onclick="cancelEditSpeaker(${speaker.id})">Cancel</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Add new speaker
        function addNewSpeaker() {
            const container = document.getElementById('speakersContainer');
            const newSpeakerForm = `
                <div class="package-item" id="newSpeakerForm">
                    <div class="package-header">
                        <h5>Add New Speaker</h5>
                    </div>
                    <div class="package-form">
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="newSpeakerName" required>
                        </div>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="newSpeakerTitle">
                        </div>
                        <div class="form-group">
                            <label>Company</label>
                            <input type="text" id="newSpeakerCompany">
                        </div>
                        <div class="form-group">
                            <label>Bio</label>
                            <textarea id="newSpeakerBio" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Profile Image</label>
                            <div class="image-upload-container">
                                <input type="file" id="newSpeakerImageFile" accept="image/*" onchange="previewImage('new', this)" style="margin-bottom: 10px;">
                                <input type="url" id="newSpeakerImage" placeholder="Or enter image URL" style="margin-bottom: 10px;" onchange="clearFileInput('new')">
                                <div id="imagePreviewNew" class="image-preview"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn-primary" onclick="createSpeaker()">Create Speaker</button>
                            <button type="button" class="btn-secondary" onclick="cancelNewSpeaker()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('afterbegin', newSpeakerForm);
        }
        
        // Create speaker
        async function createSpeaker() {
            const name = document.getElementById('newSpeakerName').value.trim();
            const title = document.getElementById('newSpeakerTitle').value.trim();
            const company = document.getElementById('newSpeakerCompany').value.trim();
            const bio = document.getElementById('newSpeakerBio').value.trim();
            const imageUrlInput = document.getElementById('newSpeakerImage').value.trim();
            const imageFile = document.getElementById('newSpeakerImageFile').files[0];
            
            if (!name) {
                alert('Speaker name is required');
                return;
            }
            
            let imageUrl = imageUrlInput;
            
            // If a file is selected, upload it first
            if (imageFile) {
                try {
                    imageUrl = await uploadImage(imageFile);
                } catch (error) {
                    alert('Failed to upload image. Please try again.');
                    return;
                }
            }
            
            const speakerData = {
                name: name,
                title: title,
                company: company,
                bio: bio,
                image_url: imageUrl
            };
            
            try {
                const response = await fetch(`${API_URL}/admin/speakers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(speakerData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create speaker');
                }
                
                alert('Speaker created successfully!');
                cancelNewSpeaker();
                await loadSpeakers();
            } catch (error) {
                console.error('Error creating speaker:', error);
                alert('Error creating speaker: ' + error.message);
            }
        }
        
        // Cancel new speaker
        function cancelNewSpeaker() {
            const form = document.getElementById('newSpeakerForm');
            if (form) {
                form.remove();
            }
        }
        
        // Edit speaker
        function editSpeaker(speakerId) {
            const editForm = document.getElementById(`editSpeaker${speakerId}`);
            editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
        }
        
        // Update speaker
        async function updateSpeaker(speakerId) {
            const name = document.getElementById(`speakerName${speakerId}`).value.trim();
            const title = document.getElementById(`speakerTitle${speakerId}`).value.trim();
            const company = document.getElementById(`speakerCompany${speakerId}`).value.trim();
            const bio = document.getElementById(`speakerBio${speakerId}`).value.trim();
            const imageUrlInput = document.getElementById(`speakerImage${speakerId}`).value.trim();
            const imageFile = document.getElementById(`speakerImageFile${speakerId}`).files[0];
            
            if (!name) {
                alert('Speaker name is required');
                return;
            }
            
            let imageUrl = imageUrlInput;
            
            // If a file is selected, upload it first
            if (imageFile) {
                try {
                    imageUrl = await uploadImage(imageFile);
                } catch (error) {
                    alert('Failed to upload image. Please try again.');
                    return;
                }
            }
            
            const speakerData = {
                name: name,
                title: title,
                company: company,
                bio: bio,
                image_url: imageUrl
            };
            
            try {
                const response = await fetch(`${API_URL}/admin/speakers/${speakerId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(speakerData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update speaker');
                }
                
                alert('Speaker updated successfully!');
                await loadSpeakers();
            } catch (error) {
                console.error('Error updating speaker:', error);
                alert('Error updating speaker: ' + error.message);
            }
        }
        
        // Cancel edit speaker
        function cancelEditSpeaker(speakerId) {
            const editForm = document.getElementById(`editSpeaker${speakerId}`);
            editForm.style.display = 'none';
        }
        
        // Delete speaker
        async function deleteSpeaker(speakerId) {
            if (!confirm('Are you sure you want to delete this speaker?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/admin/speakers/${speakerId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete speaker');
                }
                
                alert('Speaker deleted successfully!');
                await loadSpeakers();
            } catch (error) {
                console.error('Error deleting speaker:', error);
                alert('Error deleting speaker: ' + error.message);
            }
        }
        
        // Image preview function
        function previewImage(speakerId, input) {
            const previewContainer = document.getElementById(`imagePreview${speakerId}`);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewContainer.innerHTML = `<img src="${e.target.result}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">`;
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // Upload image function
        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/upload/speaker-image', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const result = await response.json();
                return result.imageUrl;
            } catch (error) {
                console.error('Upload error:', error);
                throw error;
            }
        }
        
        // Clear file input when URL is entered
        function clearFileInput(speakerId) {
            const fileInput = document.getElementById(`${speakerId === 'new' ? 'newSpeakerImageFile' : `speakerImageFile${speakerId}`}`);
            if (fileInput) {
                fileInput.value = '';
            }
        }

        // CONTACT FORMS MANAGEMENT
        
        // Load contact forms
        async function loadContactForms() {
            try {
                const response = await fetch(`${API_URL}/admin/contact-forms`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const contactForms = await response.json();
                displayContactForms(contactForms);
            } catch (error) {
                console.error('Error loading contact forms:', error);
                document.getElementById('contactFormsTableBody').innerHTML = '<tr><td colspan="7" class="error-text">Failed to load contact forms</td></tr>';
            }
        }
        
        // Display contact forms in table
        function displayContactForms(contactForms) {
            const tbody = document.getElementById('contactFormsTableBody');
            
            if (contactForms.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">No contact forms found</td></tr>';
                return;
            }
            
            tbody.innerHTML = contactForms.map(form => {
                const date = new Date(form.created_at);
                const day = date.getDate();
                const suffix = getDaySuffix(day);
                const month = date.toLocaleDateString('en-US', { month: 'long' });
                const time = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const formattedDate = `${day}${suffix} ${month}, ${time}`;
                
                return `
                    <tr>
                        <td>${form.id}</td>
                        <td>${escapeHtml(form.name)}</td>
                        <td>${escapeHtml(form.phone)}</td>
                        <td>${escapeHtml(form.email)}</td>
                        <td title="${escapeHtml(form.message)}">${escapeHtml(form.message.substring(0, 50))}${form.message.length > 50 ? '...' : ''}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="btn-small btn-danger" onclick="deleteContactForm(${form.id})" title="Delete">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Export contact forms
        async function exportContactForms() {
            try {
                const response = await fetch(`${API_URL}/admin/contact-forms/export`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Convert to CSV format for Excel compatibility
                const headers = ['ID', 'Name', 'Phone', 'Email', 'Message', 'Submitted At'];
                const csvContent = [
                    headers.join(','),
                    ...data.map(row => [
                        row.id,
                        `"${row.name.replace(/"/g, '""')}"`,
                        `"${row.phone}"`,
                        `"${row.email}"`,
                        `"${row.message.replace(/"/g, '""')}"`,
                        `"${row.submitted_at}"`
                    ].join(','))
                ].join('\n');
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `contact_forms_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Contact forms exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Failed to export contact forms. Please try again.');
            }
        }
        
        // Delete contact form
        async function deleteContactForm(id) {
            if (!confirm('Are you sure you want to delete this contact form?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/admin/contact-forms/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // Reload contact forms
                await loadContactForms();
                alert('Contact form deleted successfully!');
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete contact form. Please try again.');
            }
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // Helper function to get day suffix (1st, 2nd, 3rd, 4th, etc.)
        function getDaySuffix(day) {
            if (day >= 11 && day <= 13) {
                return 'th';
            }
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
        
        // CONTACT INFORMATION MANAGEMENT
        
        // Load contact information
        async function loadContactInfo() {
            try {
                const response = await fetch(`${API_URL}/admin/contact-info`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const contactInfo = await response.json();
                
                if (contactInfo) {
                    // Populate phone numbers (array to textarea)
                    if (contactInfo.phone_numbers && Array.isArray(contactInfo.phone_numbers)) {
                        document.getElementById('contactPhones').value = contactInfo.phone_numbers.join('\n');
                    }
                    
                    // Populate email
                    if (contactInfo.email) {
                        document.getElementById('contactEmail').value = contactInfo.email;
                    }
                    
                    // Populate location fields
                    if (contactInfo.location) {
                        document.getElementById('contactVenue').value = contactInfo.location.venue || '';
                        document.getElementById('contactArea').value = contactInfo.location.area || '';
                        document.getElementById('contactBuilding').value = contactInfo.location.building || '';
                        document.getElementById('contactAddress').value = contactInfo.location.address || '';
                        document.getElementById('contactCity').value = contactInfo.location.city || '';
                    }
                }
            } catch (error) {
                console.error('Error loading contact info:', error);
                // Set default values if API fails
                document.getElementById('contactPhones').value = '+91 99406 25080\n+91 78100 78717\n+91 63699 97015\n+91 99522 47355';
                document.getElementById('contactEmail').value = 'manikandan@aicraise.com';
                document.getElementById('contactVenue').value = 'Rathinam Grand Hall';
                document.getElementById('contactArea').value = 'Eachanari - 021';
                document.getElementById('contactBuilding').value = 'Rathinam Tech Park';
                document.getElementById('contactAddress').value = 'Pollachi Main Rd, Eachanari';
                document.getElementById('contactCity').value = 'Coimbatore, Tamil Nadu 641021';
            }
        }
        
        // Contact info form handler
        document.getElementById('contactInfoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get form values
            const phonesText = document.getElementById('contactPhones').value.trim();
            const phoneNumbers = phonesText ? phonesText.split('\n').map(phone => phone.trim()).filter(phone => phone) : [];
            
            const contactData = {
                phone_numbers: phoneNumbers,
                email: document.getElementById('contactEmail').value.trim(),
                location: {
                    venue: document.getElementById('contactVenue').value.trim(),
                    area: document.getElementById('contactArea').value.trim(),
                    building: document.getElementById('contactBuilding').value.trim(),
                    address: document.getElementById('contactAddress').value.trim(),
                    city: document.getElementById('contactCity').value.trim()
                }
            };
            
            // Validate required fields
            if (!contactData.email) {
                alert('Email address is required.');
                document.getElementById('contactEmail').focus();
                return;
            }
            
            if (phoneNumbers.length === 0) {
                alert('At least one phone number is required.');
                document.getElementById('contactPhones').focus();
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/admin/contact-info`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(contactData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to update contact information');
                }
                
                alert('Contact information updated successfully! The changes will appear on the main page.');
                
                // Refresh the form to show updated data
                await loadContactInfo();
                
            } catch (error) {
                console.error('Error updating contact info:', error);
                alert('Error updating contact information: ' + error.message);
            }
        });
    </script>
</body>
</html>
